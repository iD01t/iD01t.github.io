<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Audiobooks · iD01t Productions</title>
  <meta name="description" content="Audiobooks by iD01t Productions — narrated titles, spoken word, and audio editions. Live from Google Books API."/>
  <link rel="canonical" href="https://id01t.github.io/audiobooks.html"/>
  <meta name="theme-color" content="#16185c"/>
  <meta property="og:type" content="website"/>
  <meta property="og:title" content="Audiobooks · iD01t Productions"/>
  <meta property="og:description" content="Browse narrated titles and audio editions by Guillaume Lessard."/>
  <meta property="og:image" content="https://id01t.github.io/assets/img/placeholders/card-square-640.webp"/>
  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="twitter:title" content="Audiobooks · iD01t Productions"/>
  <meta name="twitter:description" content="Narrated titles and audio editions."/>

  <script src="https://cdn.tailwindcss.com"></script>
  
  <script>
    // Shell helpers
    (function(){
      var y = document.getElementById('year'); if (y) y.textContent = new Date().getFullYear();
      var themeToggle = document.getElementById('themeToggle');
      if (themeToggle) {
        themeToggle.addEventListener('click', function() {
          var isDark = document.documentElement.classList.toggle('dark');
          localStorage.setItem('theme', isDark ? 'dark' : 'light');
          themeToggle.setAttribute('aria-pressed', String(isDark));
        });
      }
      var mobileMenuBtn = document.getElementById('mobileMenuBtn');
      var mobileMenu = document.getElementById('mobileMenu');
      if (mobileMenuBtn && mobileMenu) {
        mobileMenuBtn.addEventListener('click', function() {
          mobileMenu.classList.toggle('hidden');
        });
      }
    })();

    // ---------- Audiobooks Catalog (Google Books + Local landing pages) ----------
    const C = {
      AUTHOR: 'Guillaume Lessard',
      PUBLISHER: 'iD01t Productions',
      PAGE_SIZE: 40,      // Google Books max per page
      MAX_TOTAL: 200,     // up to 5 pages
      API_KEY: ''         // optional to increase quota
    };

    // Elements
    const el = id => document.getElementById(id);
    const q=el('q'), language=el('language'), from=el('from'), to=el('to'), sort=el('sort');
    const resetBtn=el('reset'), grid=el('grid'), empty=el('empty'), count=el('count'), tally=el('tally');

    // Utils
    const escapeHtml = s => String(s || '').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));

    const sleep = ms => new Promise(r=>setTimeout(r, ms));

    async function fetchWithTimeout(url, opts={}, timeout=9000){
      const ctrl = new AbortController();
      const id = setTimeout(()=>ctrl.abort(), timeout);
      try{
        const res = await fetch(url, { ...opts, signal: ctrl.signal, cache: 'no-store' });
        return res;
      } finally {
        clearTimeout(id);
      }
    }

    // Try to resolve a local landing page under /audiobooks/
    async function resolveLocalLanding(a){
      async function exists(url){
        try{
          let res = await fetchWithTimeout(url, {method:'HEAD'}, 4000);
          if (res.ok) return true;
          res = await fetchWithTimeout(url, {method:'GET'}, 6000);
          return res.ok;
        }catch(e){ return false; }
      }
      const safe = s => (s||'')
        .toLowerCase()
        .normalize('NFKD')
        .replace(/[\u0300-\u036f]/g,'')
        .replace(/&/g,' and ')
        .replace(/[^a-z0-9]+/g,'-')
        .replace(/^-+|-+$/g,'');

      const titleSlug = safe(a.title);
      const authorSlug = safe((a.authors||'').split(',')[0]);
      const combos = [
        `/audiobooks/${titleSlug}.html`,
        `/audiobooks/${titleSlug}/index.html`,
        `/audiobooks/${authorSlug}-${titleSlug}.html`,
        `/audiobooks/${authorSlug}/${titleSlug}.html`,
      ];

      const MAP = (window.AUDIOBOOK_MAP || {});
      if (MAP[a.id]) {
        const m = MAP[a.id];
        if (await exists(m)) return m;
      }
      for (const p of combos){
        if (await exists(p)) return p;
      }
      return null;
    }

    // Google Books fetch with retries
    async function fetchAll(){
      const base = `inauthor:"${C.AUTHOR}" OR inpublisher:"${C.PUBLISHER}"`;
      let start = 0, items = [];
      while (start < C.MAX_TOTAL){
        const params = new URLSearchParams({ q: base, maxResults: C.PAGE_SIZE, startIndex: start, printType: 'books', projection: 'full' });
        if (C.API_KEY) params.set('key', C.API_KEY);
        const url = `https://www.googleapis.com/books/v1/volumes?${params.toString()}`;
        let data = null, ok=false;
        for (let attempt=0; attempt<3 && !ok; attempt++){
          try{
            const res = await fetchWithTimeout(url, {}, 9000);
            if(!res.ok) throw new Error('HTTP '+res.status);
            data = await res.json(); ok=true;
          }catch(e){ await sleep(350*(attempt+1)); }
        }
        if(!ok) throw new Error('Books API unavailable');
        const page = (data && data.items) ? data.items : [];
        items.push(...page);
        if (page.length < C.PAGE_SIZE) break;
        start += C.PAGE_SIZE;
      }
      return items;
    }

    function isAudio(vinfo){
      const t = ((vinfo.title||'')+' '+(vinfo.subtitle||'')).toLowerCase();
      const c = (vinfo.categories||[]).join(' ').toLowerCase();
      const s = (vinfo.searchInfo?.textSnippet||'').toLowerCase();
      const hints = ['audiobook','audio book','spoken word','narrated','unabridged','abridged'];
      return hints.some(h=>t.includes(h)||c.includes(h)||s.includes(h));
    }

    function normalize(item){
      const v = item.volumeInfo || {}, links=v.imageLinks||{};
      return {
        id: item.id,
        title: v.title || 'Untitled',
        authors: (v.authors||[]).join(', '),
        year: (v.publishedDate||'').slice(0,4),
        language: v.language || '',
        categories: v.categories || [],
        image: (links.thumbnail||links.smallThumbnail||'/assets/placeholder-cover.svg').replace('http://','https://'),
        infoLink: (v.infoLink || v.canonicalVolumeLink || '#').replace('http://','https://'),
        audio: isAudio(v)
      };
    }

    function populateLanguages(items){
      const langs = Array.from(new Set(items.map(x=>x.language).filter(Boolean))).sort();
      language.innerHTML = '<option value="">All languages</option>' + langs.map(l=>`<option value="${l}">${l}</option>`).join('');
    }

    function card(a){
      const cats = [a.language, ...(a.categories||[]).slice(0,1), a.audio?'Audiobook':'Book'].filter(Boolean);
      const localHref = a.localUrl || a.infoLink;
      return `
      <article class="rounded-2xl border border-slate-200 dark:border-slate-800 overflow-hidden bg-white dark:bg-slate-900 flex flex-col card">
        <img src="${a.image}" alt="${escapeHtml(a.title)} cover" class="w-full aspect-[3/4] object-cover">
        <div class="p-4 flex-1 flex flex-col">
          <h3 class="font-semibold leading-snug">${escapeHtml(a.title)}</h3>
          <p class="text-xs text-slate-500 mt-1">${escapeHtml(a.authors||'')}</p>
          <div class="mt-2 flex flex-wrap gap-2">
            ${cats.map(t=>`<span class="text-xs rounded-full border border-slate-300 dark:border-slate-700 px-2 py-0.5">${escapeHtml(t)}</span>`).join('')}
          </div>
          <div class="mt-auto pt-4 flex items-center justify-between gap-2">
            <span class="text-sm text-slate-500">${a.year||''}</span>
            <div class="flex items-center gap-2">
              <a href="${localHref}" class="rounded-full bg-brand-600 hover:bg-brand-700 text-white px-4 py-2 text-sm">Details</a>
              <a href="${a.infoLink}" target="_blank" rel="noopener nofollow" class="text-sm underline">Google Books</a>
            </div>
          </div>
        </div>
      </article>`;
    }

    function applyFilters(items){
      const text=(q.value||'').toLowerCase();
      const lang=language.value; const f=parseInt(from.value||''); const t=parseInt(to.value||'');
      let list = items.filter(x=>{
        if(text){
          const hay=[x.title,x.authors,(x.categories||[]).join(' ')].join(' ').toLowerCase();
          if(!hay.includes(text)) return false;
        }
        if(lang && x.language!==lang) return false;
        if(!isNaN(f) && (x.year||0) < f) return false;
        if(!isNaN(t) && (x.year||0) > t) return false;
        return x.audio; // audiobooks only
      });
      const s=sort.value, byTitle=(a,b)=>a.title.localeCompare(b.title);
      if (s==='date_asc') list.sort((a,b)=>(a.year||0)-(b.year||0));
      else if (s==='title_asc') list.sort(byTitle);
      else if (s==='title_desc') list.sort((a,b)=>byTitle(b,a));
      else list.sort((a,b)=>(b.year||0)-(a.year||0)); // newest
      return list;
    }

    function emitSchema(items){
      const ld={ '@context':'https://schema.org','@type':'ItemList', name:'Audiobooks',
        itemListElement: items.slice(0,60).map((a,i)=>({ '@type':'ListItem', position:i+1,
          item:{ '@type':'Audiobook', name:a.title, inLanguage:a.language, datePublished:a.year?String(a.year):undefined, image:a.image, url:a.localUrl||a.infoLink }
        }))
      };
      let tag=document.getElementById('ld-ab');
      if(!tag){ tag=document.createElement('script'); tag.id='ld-ab'; tag.type='application/ld+json'; document.head.appendChild(tag); }
      tag.textContent = JSON.stringify(ld);
    }

    function render(list, all){
      if (!list.length){ grid.innerHTML=''; empty.classList.remove('hidden'); count.textContent='0 audiobooks'; return; }
      empty.classList.add('hidden');
      grid.innerHTML = list.map(card).join('');
      count.textContent = `${list.length} audiobook${list.length!==1?'s':''}`;
      const audioCount = all.filter(x=>x.audio).length;
      tally.textContent = `${all.length} titles • ${audioCount} audiobooks`;
      emitSchema(list);
    }

    function bind(all){
      const again=()=>render(applyFilters(all), all);
      ['input','change'].forEach(evt=>[q,language,from,to,sort].forEach(e=>e.addEventListener(evt,again)));
      resetBtn.addEventListener('click',()=>{q.value='';language.value='';from.value='';to.value='';sort.value='date_desc';again();});
    }

    async function init(){
      try{
        const raw = await fetchAll();
        let all = raw.map(normalize);
        // Resolve local landing pages with small batches
        const batch = 6;
        for (let i=0; i<all.length; i+=batch){
          await Promise.all(all.slice(i,i+batch).map(async x=>{ x.localUrl = await resolveLocalLanding(x); }));
          await sleep(40);
        }
        populateLanguages(all);
        bind(all);
        render(applyFilters(all), all);
      }catch(err){
        try{
          // JSON fallback
          const r=await fetchWithTimeout('/assets/data/audiobooks.json', {}, 8000);
          const fb=await r.json();
          const arr=(Array.isArray(fb)?fb:(fb.items||[]));
          const all=arr.map(a=>({
            id:a.id||a.title, title:a.title, authors:(a.authors||a.narrators||[]).join(', '),
            year:a.year, language:a.language, categories:[a.genre].filter(Boolean),
            infoLink:(a.googleBooks||a.googlePlay||a.url||'#'), image:a.cover, audio:true, localUrl:a.url
          }));
          populateLanguages(all); bind(all); render(applyFilters(all), all);
        }catch(e2){
          grid.innerHTML = '<div class="text-slate-500">Could not load audiobooks from API or fallback JSON.</div>'; empty.classList.remove('hidden');
        }
      }
    }

    init();
  </script>

</body>
</html>
