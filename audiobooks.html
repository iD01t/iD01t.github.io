# Generate a fully rewritten, bullet-proof audiobooks.html
from pathlib import Path

api_key = "AIzaSyBpG4uswyDjQXfZbIOfW7hwg2Il0RaUYYs"

html = f"""<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Audiobooks Â· iD01t Productions</title>
  <meta name="description" content="Browse audiobooks from iD01t Productions. Live Google Books integration with resilient fallbacks and a professional card grid.">
  <link rel="icon" href="/assets/img/brand/favicon.png">
  <link rel="preconnect" href="https://www.googleapis.com">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {{
      theme: {{
        extend: {{
          colors: {{
            brand: {{ 50:'#f5f6ff',100:'#e6e9ff',200:'#c9ccff',300:'#a2a8ff',400:'#7a82ff',500:'#545cff',600:'#3a3fe6',700:'#2c30b4',800:'#202383',900:'#16185c' }}
          }}
        }}
      }}
    }};
  </script>
  <style>
    .link-underline {{ position:relative }}
    .link-underline::after {{ content:''; position:absolute; left:0; bottom:-2px; width:100%; height:1px; background: currentColor; transform:scaleX(0); transform-origin:left; transition: transform .2s }}
    .link-underline:hover::after {{ transform:scaleX(1) }}
  </style>
  <script>(function(){{const s=localStorage.getItem('theme');const d=matchMedia('(prefers-color-scheme: dark)').matches;if(s==='dark'||(!s&&d))document.documentElement.classList.add('dark');}})();</script>
</head>
<body class="min-h-full bg-white text-slate-900 dark:bg-slate-950 dark:text-slate-100">
  <!-- Header -->
  <header class="sticky top-0 z-50 backdrop-blur supports-backdrop-blur:bg-white/70 bg-white/70 dark:bg-slate-950/60 border-b border-slate-200/60 dark:border-slate-800">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <a href="/" class="flex items-center gap-2" aria-label="Home">
          <img src="/assets/img/brand/logo.png" class="h-8 w-8" alt="iD01t Productions">
          <span class="font-semibold tracking-tight">iD01t Productions</span>
        </a>
        <nav class="hidden md:flex items-center gap-6" aria-label="Primary">
          <a href="/store.html" class="link-underline">Store</a>
          <a href="/ebooks.html" class="link-underline">eBooks</a>
          <a href="/audiobooks.html" class="link-underline" aria-current="page">Audiobooks</a>
          <a href="/apps.html" class="link-underline">Apps</a>
          <a href="/games.html" class="link-underline">Games</a>
          <a href="/music.html" class="link-underline">Music</a>
          <a href="/blog.html" class="link-underline">Blog</a>
          <a href="/about.html" class="link-underline">About</a>
          <a href="/contact.html" class="link-underline">Contact</a>
        </nav>
        <div class="flex items-center gap-3">
          <button id="themeToggle" class="rounded-full border border-slate-300 dark:border-slate-700 px-3 py-1 text-sm">Theme</button>
          <a href="/#newsletter" class="inline-flex items-center rounded-full bg-brand-600 hover:bg-brand-700 text-white text-sm px-4 py-2">Newsletter</a>
          <button id="mobileMenuBtn" class="md:hidden inline-flex items-center justify-center p-2 rounded-lg border border-slate-300 dark:border-slate-700" aria-label="Open menu">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
          </button>
        </div>
      </div>
    </div>
    <div id="mobileMenu" class="md:hidden hidden border-t border-slate-200 dark:border-slate-800" role="dialog" aria-modal="true">
      <div class="px-4 py-3 flex flex-col gap-2">
        <a href="/store.html" class="py-2">Store</a>
        <a href="/ebooks.html" class="py-2">eBooks</a>
        <a href="/audiobooks.html" class="py-2">Audiobooks</a>
        <a href="/apps.html" class="py-2">Apps</a>
        <a href="/games.html" class="py-2">Games</a>
        <a href="/music.html" class="py-2">Music</a>
        <a href="/blog.html" class="py-2">Blog</a>
        <a href="/about.html" class="py-2">About</a>
        <a href="/contact.html" class="py-2">Contact</a>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="relative overflow-hidden">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 pt-12 pb-6">
      <div class="text-center">
        <h1 class="text-4xl sm:text-5xl font-bold tracking-tight">Audiobooks</h1>
        <p class="mt-3 text-slate-600 dark:text-slate-300">Narrated editions and spoken word, auto populated from Google Books with reliable fallbacks.</p>
      </div>
    </div>
  </section>

  <!-- Controls -->
  <main class="py-8 border-t border-slate-200 dark:border-slate-800">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="flex flex-wrap items-end gap-3">
        <div class="flex-1 min-w-[220px]">
          <label class="sr-only" for="q">Search</label>
          <input id="q" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 p-3" placeholder="Title or author">
        </div>
        <div>
          <label class="sr-only" for="language">Language</label>
          <select id="language" class="rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 p-3">
            <option value="">All languages</option>
          </select>
        </div>
        <div>
          <label class="sr-only" for="from">From year</label>
          <input id="from" type="number" class="w-28 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 p-3" placeholder="From">
        </div>
        <div>
          <label class="sr-only" for="to">To year</label>
          <input id="to" type="number" class="w-28 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 p-3" placeholder="To">
        </div>
        <div>
          <label class="sr-only" for="sort">Sort</label>
          <select id="sort" class="rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 p-3">
            <option value="date_desc">Newest</option>
            <option value="date_asc">Oldest</option>
            <option value="title_asc">Title A to Z</option>
            <option value="title_desc">Title Z to A</option>
          </select>
        </div>
        <button id="reset" class="rounded-full bg-slate-200 dark:bg-slate-800 px-4 py-2">Reset</button>
      </div>

      <div class="mt-6 flex items-center justify-between">
        <p id="count" class="text-sm text-slate-500">Loadingâ€¦</p>
        <p id="tally" class="text-sm text-slate-500"></p>
      </div>

      <div id="loading" class="mt-6 rounded-xl border border-slate-200 dark:border-slate-800 p-4 text-slate-600 dark:text-slate-300">ðŸŽ§ Loading iD01t Productions audiobooksâ€¦</div>
      <div id="empty" class="hidden mt-6 rounded-xl border border-slate-200 dark:border-slate-800 p-4 text-slate-600 dark:text-slate-300">No audiobooks match your filters.</div>

      <div id="grid" class="grid gap-8 sm:grid-cols-2 lg:grid-cols-3 mt-4"></div>
      <noscript><div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 text-slate-500 py-4">Enable JavaScript to view the audiobooks catalog.</div></noscript>
    </div>
  </main>

  <!-- Footer -->
  <footer class="py-10 border-t border-slate-200 dark:border-slate-800">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-6">
        <div>
          <p class="font-semibold">iD01t Productions</p>
          <p class="text-sm text-slate-500">Â© <span id="year"></span> All rights reserved</p>
        </div>
        <nav class="flex flex-wrap gap-4 text-sm">
          <a href="/legal/terms.html" class="link-underline">Terms</a>
          <a href="/legal/privacy.html" class="link-underline">Privacy</a>
          <a href="/legal/refunds.html" class="link-underline">Refunds</a>
          <a href="https://github.com/id01t" class="link-underline" target="_blank" rel="noopener">GitHub</a>
          <a href="https://id01t.itch.io" class="link-underline" target="_blank" rel="noopener">itch.io</a>
        </nav>
      </div>
    </div>
  </footer>

  <!-- Fallback data file (optional). If present, defines window.AUDIOBOOK_FALLBACK -->
  <script src="/assets/data/audiobooks.js"></script>

  <!-- Client logic -->
  <script>
    // Shell behavior
    (function() {{
      const y = document.getElementById('year'); if (y) y.textContent = new Date().getFullYear();
      const themeToggle = document.getElementById('themeToggle');
      if (themeToggle) {{
        themeToggle.addEventListener('click', function() {{
          const isDark = document.documentElement.classList.toggle('dark');
          localStorage.setItem('theme', isDark ? 'dark' : 'light');
          themeToggle.setAttribute('aria-pressed', String(isDark));
        }});
      }}
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      const mobileMenu = document.getElementById('mobileMenu');
      if (mobileMenuBtn && mobileMenu) {{
        mobileMenuBtn.addEventListener('click', function() {{ mobileMenu.classList.toggle('hidden'); }});
      }}
    }})();

    // Helpers
    function sleep(ms) {{ return new Promise(r=>setTimeout(r, ms)); }}
    async function fetchWithTimeout(url, opts={{}}, timeout=9000) {{
      const ctrl = new AbortController();
      const id = setTimeout(()=>ctrl.abort(), timeout);
      try {{ return await fetch(url, {{ ...opts, signal: ctrl.signal, cache:'no-store' }}); }}
      finally {{ clearTimeout(id); }}
    }}
    function escapeHtml(s) {{ return String(s||'').replace(/[&<>"]/g, c => ({{'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}})[c]); }}

    // Detect audiobook
    function isAudiobook(v) {{
      const hay = ((v.title||'')+' '+(v.subtitle||'')+' '+(v.categories||[]).join(' ')+' '+(v.description||'')+' '+(v.searchInfo?.textSnippet||'')).toLowerCase();
      const hints = ['audiobook','audio book','spoken word','narrated','unabridged','abridged','read by','narrator'];
      return hints.some(h => hay.includes(h));
    }}

    // Normalize
    function normalize(it) {{
      const v = it.volumeInfo || {{}};
      const links = v.imageLinks || {{}};
      return {{
        id: it.id,
        title: v.title || 'Untitled',
        authors: (v.authors || []).join(', '),
        year: (v.publishedDate||'').slice(0,4) || '',
        language: v.language || '',
        categories: v.categories || [],
        image: (links.thumbnail || links.smallThumbnail || '/assets/img/brand/ebooks.png').replace(/^http:/,'https:'),
        infoLink: (v.infoLink || v.canonicalVolumeLink || '#').replace(/^http:/,'https:'),
        audio: isAudiobook(v)
      }};
    }}

    // Local landing resolver
    async function resolveLocalLanding(a) {{
      async function exists(url) {{
        try {{ let r = await fetchWithTimeout(url, {{method:'HEAD'}}, 3500); if (r.ok) return true; r = await fetchWithTimeout(url, {{method:'GET'}}, 4500); return r.ok; }}
        catch(e) {{ return false; }}
      }}
      const safe = s => (s||'').toLowerCase().normalize('NFKD').replace(/[\\u0300-\\u036f]/g,'').replace(/&/g,' and ').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
      const t = safe(a.title); const auth = safe((a.authors||'').split(',')[0]||'');
      const combos = [`/audiobooks/${{t}}.html`, `/audiobooks/${{t}}/index.html`, `/audiobooks/${{auth}}-${{t}}.html`, `/audiobooks/${{auth}}/${{t}}.html`];
      const MAP = window.AUDIOBOOK_MAP || {{}};
      if (MAP[a.id] && await exists(MAP[a.id])) return MAP[a.id];
      for (const p of combos) {{ if (await exists(p)) return p; }}
      return null;
    }}

    // Populate languages
    function populateLanguages(items) {{
      const el = document.getElementById('language');
      const langs = Array.from(new Set(items.map(x=>x.language).filter(Boolean))).sort();
      el.innerHTML = '<option value=\"\">All languages</option>' + langs.map(l=>`<option value=\"${{l}}\">${{l}}</option>`).join('');
    }}

    // Card
    function card(a) {{
      const chips = [a.language, ...(a.categories||[]).slice(0,1), a.audio ? 'Audiobook' : 'Book'].filter(Boolean);
      const href = a.localUrl || a.infoLink || '#';
      return `
      <article class="rounded-2xl border border-slate-200 dark:border-slate-800 overflow-hidden bg-white dark:bg-slate-900 flex flex-col">
        <img src="${{escapeHtml(a.image)}}" alt="${{escapeHtml(a.title)}} cover" class="w-full aspect-[3/4] object-cover">
        <div class="p-4 flex-1 flex flex-col">
          <h3 class="font-semibold leading-snug">${{escapeHtml(a.title)}}</h3>
          <p class="text-xs text-slate-500 mt-1">${{escapeHtml(a.authors||'')}}</p>
          <div class="mt-2 flex flex-wrap gap-2">${{chips.map(c=>`<span class="text-xs rounded-full border border-slate-300 dark:border-slate-700 px-2 py-0.5">${{escapeHtml(c)}}</span>`).join('')}}</div>
          <div class="mt-auto pt-4 flex items-center justify-between gap-2">
            <span class="text-sm text-slate-500">${{escapeHtml(a.year)}}</span>
            <div class="flex items-center gap-2">
              <a href="${{href}}" class="rounded-full bg-brand-600 hover:bg-brand-700 text-white px-4 py-2 text-sm">Details</a>
              <a href="${{escapeHtml(a.infoLink)}}" target="_blank" rel="noopener nofollow" class="text-sm underline">Google Books</a>
            </div>
          </div>
        </div>
      </article>`;
    }}

    // Apply filters
    function applyFilters(items) {{
      const q = (document.getElementById('q').value||'').toLowerCase();
      const lang = document.getElementById('language').value;
      const from = parseInt(document.getElementById('from').value||'')||0;
      const to = parseInt(document.getElementById('to').value||'')||0;
      const sort = document.getElementById('sort').value;

      let list = items.filter(x=> {{
        if (q) {{ const hay = `${{x.title}} ${{x.authors}} ${(x.categories||[]).join(' ')}`.toLowerCase(); if(!hay.includes(q)) return false; }}
        if (lang && x.language !== lang) return false;
        const yr = parseInt(x.year||'')||0;
        if (from && yr < from) return false;
        if (to && yr > to) return false;
        return x.audio;
      }});

      if (sort==='date_asc') list.sort((a,b)=>(parseInt(a.year)||0)-(parseInt(b.year)||0));
      else if (sort==='title_asc') list.sort((a,b)=>a.title.localeCompare(b.title));
      else if (sort==='title_desc') list.sort((a,b)=>b.title.localeCompare(a.title));
      else list.sort((a,b)=>(parseInt(b.year)||0)-(parseInt(a.year)||0));

      return list;
    }}

    // Schema
    function emitSchema(items) {{
      const ld={{'@context':'https://schema.org','@type':'ItemList','name':'Audiobooks',
        itemListElement: items.slice(0,60).map((a,i)=>({{'@type':'ListItem',position:i+1,item:{{'@type':'Audiobook',name:a.title,inLanguage:a.language,datePublished:a.year||undefined,image:a.image,url:a.localUrl||a.infoLink}}}}))
      }};
      let tag=document.getElementById('ld-ab'); if(!tag) {{ tag=document.createElement('script'); tag.id='ld-ab'; tag.type='application/ld+json'; document.head.appendChild(tag); }}
      tag.textContent = JSON.stringify(ld);
    }}

    // Render
    function render(list, all) {{
      const loading = document.getElementById('loading');
      const empty = document.getElementById('empty');
      const grid = document.getElementById('grid');
      const count = document.getElementById('count');
      const tally = document.getElementById('tally');

      if (loading) loading.remove();
      if (!list.length) {{ grid.innerHTML=''; empty.classList.remove('hidden'); count.textContent='0 audiobooks'; return; }}
      empty.classList.add('hidden');
      grid.innerHTML = list.map(card).join('');
      count.textContent = `${{list.length}} audiobook${{list.length!==1?'s':''}}`;
      tally.textContent = `${{all.length}} titles â€¢ ${{all.filter(x=>x.audio).length}} audiobooks`;
      emitSchema(list);
    }}

    // Bind
    function bind(all) {{
      const ids = ['q','language','from','to','sort'];
      const on = () => render(applyFilters(all), all);
      ids.forEach(id=>{{ const el=document.getElementById(id); if(el){{el.addEventListener('input',on); el.addEventListener('change',on);} }});
      const reset=document.getElementById('reset'); if (reset) reset.addEventListener('click',()=>{{ ids.forEach(id=>{{const e=document.getElementById(id); if(!e) return; e.value='';}}); document.getElementById('sort').value='date_desc'; on(); }});
    }}

    // API
    async function fetchAll() {{
      const base = 'inauthor:\"Guillaume Lessard\" OR inpublisher:\"iD01t Productions\"';
      const pageSize = 40; const maxPages = 5;
      const items = [];
      for (let i=0;i<maxPages;i++) {{
        const start = i*pageSize;
        const params = new URLSearchParams({{ q: base, maxResults: pageSize, startIndex: start, printType:'books', projection:'full', key: '{api_key}' }});
        const url = `https://www.googleapis.com/books/v1/volumes?${{params.toString()}}`;
        let ok=false, data=null;
        for (let attempt=0; attempt<3 && !ok; attempt++) {{
          try {{ const r = await fetchWithTimeout(url, {{}}, 9000); if(!r.ok) throw new Error('http '+r.status); data = await r.json(); ok=true; }}
          catch(e) {{ await sleep(250*(attempt+1)); }}
        }}
        if(!ok) throw new Error('api failed');
        const page = (data && data.items) ? data.items : [];
        items.push(...page);
        if (page.length < pageSize) break;
      }}
      return items;
    }}

    async function init() {{
      const grid = document.getElementById('grid');
      try {{
        const raw = await fetchAll();
        let all = raw.map(normalize);
        // Resolve local
        for (let i=0;i<all.length;i+=6) {{
          await Promise.all(all.slice(i,i+6).map(async a=>{{ a.localUrl = await resolveLocalLanding(a); }}));
          await sleep(40);
        }}
        bind(all);
        render(applyFilters(all), all);
      }} catch(e) {{
        // Fallbacks
        let fb = null;
        if (window.AUDIOBOOK_FALLBACK && Array.isArray(window.AUDIOBOOK_FALLBACK.items)) fb = window.AUDIOBOOK_FALLBACK.items.map(a=>({{
          id:a.id||a.title,title:a.title,authors:(a.authors||a.narrators||[]).join(', '),year:a.year,language:a.language,categories:[a.genre].filter(Boolean),image:a.cover,infoLink:a.googleBooks||a.googlePlay||a.url||'#',audio:true,localUrl:a.url
        }}));
        if (!fb) {{
          try {{ const r = await fetchWithTimeout('/assets/data/audiobooks.json',{{}},8000); if (r.ok) {{ const j = await r.json(); const arr = Array.isArray(j)?j:(j.items||[]); fb = arr.map(a=>({{id:a.id||a.title,title:a.title,authors:(a.authors||a.narrators||[]).join(', '),year:a.year,language:a.language,categories:[a.genre].filter(Boolean),image:a.cover,infoLink:a.googleBooks||a.googlePlay||a.url||'#',audio:true,localUrl:a.url}})); }} }}catch(ex){{}}
        }}
        if (fb) {{ bind(fb); render(applyFilters(fb), fb); }}
        else {{ grid.innerHTML = '<div class="p-4 text-slate-600 dark:text-slate-300">Could not load audiobooks. Try again later.</div>'; document.getElementById('empty').classList.remove('hidden'); }}
      }}
    }}

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
"""

out = Path("/mnt/data/audiobooks.rewritten.html")
out.write_text(html, encoding="utf-8")
print("Saved:", out)
